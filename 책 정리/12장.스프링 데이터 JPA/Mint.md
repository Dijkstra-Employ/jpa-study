# 12. 스프링 데이터 JPA
## 12.1 스프링 데이터 JPA 소개
- `CRUD`를 처리하기 위한 공통 인터페이스 제공
    - 리포지토리 개발시 인터페이스만 작성하면 샐행 시점에 스프링 데이터 JPA가 **구현 객체를 동적으로 생성해서 주입**
- 데이터 접근 계층을 개발할 때 **구현 클래스 없이 인터페이스만 작성해도 개발 완료 가능**
- `extends JpaRepository<Member, Long>`

### 스프링 데이터 프로젝트
- 데이터 저장소에 대한 접근을 추상화해서 개발자 편의를 제공하고 반복되는 데이터 접근 코드를 줄여 준다.

## 12.2 Spring Data Jpa 설정
- `basePackages`에는 리포지토리를 검색할 패키지 위치를 적는다.
- 스프링 데이터 JPA는 애플리케이션 실행시 `basePackages`에 있는 리포지토리 인터페이스들을 찾아서 해당 인터페이스를 구현한 클래스를 동적으로 생성하여 스프링 빈으로 등록한다.
- 개발자가 직접 구현 클래스를 만들지 않아도 된다.

## 12.3 공통 인터페이스 기능
- 스프링 데이터 JPA는 간단한 CRUD 기능을 공통으로 처리하는 `JpaRepository` 인터페이스를 제공한다.
    - 단순히 이 인터페이스를 상속받고 제네릭에 엔티티 클래스와 엔티티 클래스가 사용하는 식별자 타입을 지정하면 된다.
- 스프링 데이터 : `Repository` <- `CrudRepository` <- `PagingAndSortingRepository` <- `JpaRepository`
    - 스프링 데이터 Jpa는 `JpaRepository`이고, 그 외는 스프링 데이터 프로젝트가 공통으로 사용하는 인터페이스이다.
- `save`, `delete`, `findOne`, `getOne`(프록시로 조회), `findAll` 등이 있다.

## 12.4 쿼리 메서드 기능
- `메서드 이름`만으로 쿼리를 생성하는 기능
    - 인터페이스에 메서드만 선언하면 해당 메서드의 이름으로 적절한 `jpql 쿼리`를 생성하여 실행한다.

### 1. 메서드 이름으로 쿼리 생성
- ex) `findByEmailAndName` : 이메일과 이름으로 회원 조회

### 2. 메서드 이름으로 JPA NamedQuery 호출
- 메서드 이름으로 `Jpa NamedQuery`(쿼리에 이름을 부여해서 사용) 호출 가능
- `도메인 클래스.메서드 이름`으로 Named Query를 찾아서 실행한다.
    - 실행할 `Named Query`가 없으면 **메서드 이름으로 쿼리를 생성**한다.

### 3. @Query로 쿼리 직접 정의
- 리포지토리 메서드에 직접 쿼리를 정의하려면 `@Query`를 사용하면 된다.
- 실행할 메서드에 정적 쿼리를 직접 작성하므로 `이름 없는 NamedQuery`라고 할 수 있다.
- `네이티브 sql`을 사용하려면 `@Query`에 `nativeQuery=true`를 설정하면 된다.

### 파라미터 바인딩
- 위치 기반 파라미터 바인딩 `?1`
- 이름 기반 파라미터 바인딩 `:name`을 사용하고 `@Param("name") String username`
> 코드 가독성과 유지보수성을 위해 이름 기반 파라미터 바인딩을 사용하자.

### 벌크성 수정 쿼리
- 벌크성 수정, 삭제 쿼리에는`@Modifying` 사용하면 된다.
- 벌크성 쿼리 실행 후 영속성 컨텍스트를 초기화하고 싶으면 `@Modifying(clearAutomatically=true)`를 하면 된다.

### 반환 타입
- 결과가 한 건 이상이면 `컬렉션 인터페이스`를 사용하고 단건이면 `반환 타입`을 지정한다.
- 조회 결과가 없을 경우 `빈 컬렉션`을 반환하고, 단건일 경우 `null`을 반환한다.
    - 단건 반환 타입 지정했는데 **결과가 2개 이상일 경우** `NonUniqueResultException`이 발생한다.
    - 단건 반환 타입 지정했는데 **조회 결과가 없으면** `NoResultException`이 발생하는데, 이 예외를 스프링 데이터 JPA가 무시하고 대신 `null`을 반환해준다.

### 페이징과 정렬
- `Pagable` : 페이징 기능 (내부에 Sort 포함)
    - 파라미터에 `Pageable`을 사용하면 반환 타입으로 `List`나 `Page`를 사용할 수 있다.
        - 반환타입으로 `Page`를 사용할 경우 검색된 전체 데이터 건수를 조회하는 **count 쿼리를 추가로 호출**한다.
        - `Pagable`은 인터페이스이므로 실제 사용할 때는 `PageRequest` (구현체)를 사용한다.
- `Sort` : 정렬 기능

### 힌트
- JPA Query Hint를 사용하려면 `@QueryHints`를 사용하면 된다.

### Lock
- `@Lock`을 사용하면 된다.

## 12.5 명세 (Specification)
- `DDD`의 명세 개념을 스프링 데이터 JPA에서 사용가능하다.
- `술어` : 참이나 거짓으로 평가된다.
    - AND, OR 같은 데이터를 검색하기 위한 제약조건 하나하나를 의미한다.
- 컴포지트 패턴: 여러 명세 조합 가능
- `JpaSpecificationExecutor` 인터페이스 상속받으면 된다.
    - `Specification`을 파라미터로 받아서 검색 조건으로 사용한다.
- `where(), and(), or(), not()`을 제공한다.

## 12.6 사용자 정의 레포지토리 구현
- 스프링 데이터 JPA는 필요한 메서드를 구현할 수 있도록 방법을 지원한다.
- 인터페이스를 작성한 후 구현한 클래스를 작성한다.
    - 구현한 클래스의 이름은 끝에 `Impl`이 붙어야 JPA가 사용자 정의 클래스로 인식한다.
- 리포지토리 인터페이스에서 사용자 정의 인터페이스를  상속받으면 된다.

## 12.7 Web 확장
- `도메인 클래스 컨버터 기능` : 식별자로 도메인 클래스 바인딩
- 페이징과 정렬 기능

### 도메인 클래스 컨버터 기능
- HTTP 파라미터로 넘어온 엔티티의 id로 엔티티 객체를 찾아서 바인딩해준다.
- 해당 엔티티와 관련된 레포지토리를 사용해서 엔티티를 찾는다.
> 도메인 클래스 컨버터를 통해 넘어온 회원 엔티티를 컨트롤러에서 수정해도 실제 데이터베이스에는 반영되지 않는다.

### 페이징과 정렬
- 페이징 기능 : `PageableHandlerMethodArgumentResolver`
    - 파라미터로 `Pageable`을 받는다. (인터페이스이고 실제는 `PageRequest` 객체가 생성된다.)
        - `page` : 현재 페이지, 0부터 시작
        - `size` : 한 페이지에 노출할 데이터 건수
        - `sort` : 정렬 조건 정의
    - 사용할 페이징 정보가 둘 이상이면 `접두사`를 사용하여 구분한다.
        - `@Qualifier`를 이용하며, `접두사명_`로 구분한다.
    - `Pageable`의 기본값은 `page=0, size=20`이다.
        - 기본값을 변경하고 싶으면 `@PageableDefault`를 사용한다.
- 정렬 기능 : `SortHandlerMethodArgumentResolver`

## 12.8 스프링 데이터 JPA가 사용하는 구현체
- `SimpleJpaRepository` : 스프링 데이터 JPA가 제공하는 공통 인터페이스
- 내부 코드
    - `@Repository` : JPA 예외를 스프링이 추상화한 예외로 변환
    - `@Transactional` : 트랜잭션 적용
        - 서비스 계층에서 트랜잭션을 시작하지 않으면 리포지토리에서 트랜잭션 시작
        - 서비스 계층에서 트랜잭션 시작했으면 리포지토리에서 해당 트랜잭션을 전파받아서 그대로 사용
    - `@Transactional(readOnly=true)` : 읽기 전용, 플러시를 생략해서 성능 향상 가능
    - `save()` : 새로운 엔티티(객체일 때 null, 기본 타입일때 숫자 0)이면 저장하고, 이미 있는 엔티티면 병합(`merge`)

## 12.10 QueryDsl과 통합
- `QueryDslPredicateExcutor` 상속 : 편리하지만 기능에 한계가 있다.
- `QueryDslRepositorySupport` : 편리하게 QueryDsl의 다양한 기능을 사용할 수 있다.
